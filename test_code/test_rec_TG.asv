%% - - Step 2d-2: datatype 2: time gate
cfg.tstart = 0;
cfg.tstep = 0.0488*1e-9;  
cfg.num_gates = len_bin;
cfg.tend = cfg.tstep* cfg.num_gates ;
cfg.timeGates = cfg.tstart+cfg.tstep:cfg.tstep:cfg.tend;

mesh_2 = mesh_homo;
id_slct = mesh_homo.meas.num(1:10:end);
size(id_slct)
mesh_2.meas.num = mesh_homo.meas.num(id_slct);
mesh_2.meas.coord = mesh_homo.meas.coord(id_slct,:);
mesh_2
tic; 
[dataSIM_tg_homo] = femdata_stnd_TR(mesh_2,...
    cfg.tend,cfg.tstep,'field', 'BiCGStab_GPU');
toc;   
%  plot TPSFs
h_tg=figure();
semilogy(cfg.timeGates, dataSIM_tg_homo.tpsf')
xlabel('time [s]')
title('TPSFs')
%% calculate temporal data
addpath(genpath(pathNirfaster))
% cfg.tstart = 0;
% cfg.tstep = 0.0488*1e-9 /2 ;  
% cfg.num_gates = 20 *2;
% cfg.tend = cfg.tstep* cfg.num_gates ;
cfg.timeGates = cfg.tstart+cfg.tstep:cfg.tstep:cfg.tend;
[dataSIM_tg_heter] = femdata_stnd_TR(mesh_heter,...
    cfg.tend,cfg.tstep,'field', 'BiCGStab_GPU');
%%  plot tpsfs 
 itpsf = 6
h_psf=figure()
plot(cfg.timeGates, dataSIM_tg_homo.tpsf(itpsf,:))
hold on
plot(cfg.timeGates, dataSIM_tg_heter.tpsf(itpsf,:))

%% image reconstruction: Time domain
t_cfg.range = cfg.tend;
t_cfg.step = cfg.tstep;
t_cfg.num_gates = cfg.num_gates;
MESH_COARSE = [90 90 50]/10;
MAX_ITERATIONS = 10;
REG_THIKONOV =10
tic
[meshRec_TD_SIM, pj_error_TG] = reconstruct_stnd_TD(mesh_homo,t_cfg, ...
        dataSIM_tg_heter, 'mua',[], MESH_COARSE, MAX_ITERATIONS, REG_THIKONOV)
     toc
 coords4plot = [xc yc  z0];
plot_truthVSrecon(mesh_heter, ...
            meshRec_TD_SIM,  coords4plot);    
